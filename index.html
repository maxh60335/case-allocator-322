import { useState, useEffect } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";

export default function CaseAllocator() {
  // 安全讀取 localStorage
  let saved = {};
  try {
    saved = JSON.parse(localStorage.getItem("caseAllocatorData")) || {};
  } catch (e) {
    saved = {};
  }

  const initialCounts = saved.counts && typeof saved.counts.A === "number" ? saved.counts : { A: 0, B: 0, C: 0 };
  const initialLog = Array.isArray(saved.log) ? saved.log : [];
  const initialTotal = typeof saved.total === "number" ? saved.total : 0;

  const [total, setTotal] = useState(initialTotal);
  const [counts, setCounts] = useState(initialCounts);
  const [log, setLog] = useState(initialLog);

  const ratios = { A: 3, B: 2, C: 2 };
  const ratioSum = 7;

  useEffect(() => {
    localStorage.setItem(
      "caseAllocatorData",
      JSON.stringify({ total, counts, log })
    );
  }, [total, counts, log]);

  const allocateWeek = (weekCases) => {
    let allocations = { A: 0, B: 0, C: 0 };
    let tempCounts = { ...counts };
    let tempTotal = total;

    const today = new Date();
    const dateString = today.toISOString().split('T')[0]; // YYYY-MM-DD

    for (let i = 0; i < weekCases; i++) {
      tempTotal += 1;
      const should = {
        A: (tempTotal * ratios.A) / ratioSum,
        B: (tempTotal * ratios.B) / ratioSum,
        C: (tempTotal * ratios.C) / ratioSum,
      };
      const need = {
        A: should.A - tempCounts.A,
        B: should.B - tempCounts.B,
        C: should.C - tempCounts.C,
      };

      let target = Object.keys(need).reduce((a, b) =>
        need[a] > need[b] ? a : b
      );

      if (need[target] <= 0) {
        const keys = ["A", "B", "C"];
        target = keys[Math.floor(Math.random() * 3)];
      }

      tempCounts[target] += 1;
      allocations[target] += 1;
    }

    setCounts(tempCounts);
    setTotal(tempTotal);
    setLog([
      ...log,
      {
        week: log.length + 1,
        date: dateString,
        cases: weekCases,
        allocations,
        total: tempCounts,
      },
    ]);
  };

  const resetAll = () => {
    if (confirm("確定要重置所有紀錄嗎？")) {
      setTotal(0);
      setCounts({ A: 0, B: 0, C: 0 });
      setLog([]);
      localStorage.removeItem("caseAllocatorData");
    }
  };

  return (
    <div className="p-6 max-w-2xl mx-auto space-y-4">
      <h1 className="text-2xl font-bold">每週案件抽分系統（3:2:2）</h1>

      <Card>
        <CardContent className="space-y-3 pt-4">
          <div className="flex gap-2">
            {[5, 6, 7, 8].map((n) => (
              <Button key={n} onClick={() => allocateWeek(n)}>
                抽 {n} 件
              </Button>
            ))}
            <Button variant="destructive" onClick={resetAll}>
