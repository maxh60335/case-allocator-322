<script>
// ---------------------- 左邊案件抽分 ----------------------
function allocate() {
  const codeInput = document.getElementById('codes').value.trim();
  if (!codeInput) { // 防呆：空白不執行
    alert('請輸入至少一個暗號再抽分');
    return;
  }

  let codes = codeInput.split(',').map(c=>c.trim());
  const n = codes.length; // 件數依輸入暗號數量

  let weekAlloc = { Mark:0, Galen:0, Kevin:0 };
  let weekCodes = { Mark:[], Galen:[], Kevin:[] };
  const members = ['Mark','Galen','Kevin'];

  for (let i=0;i<n;i++){
    total++;
    let should = {
      Mark: total*ratio.Mark/ratioSum,
      Galen: total*ratio.Galen/ratioSum,
      Kevin: total*ratio.Kevin/ratioSum
    };
    let need = {
      Mark: should.Mark - count.Mark,
      Galen: should.Galen - count.Galen,
      Kevin: should.Kevin - count.Kevin
    };
    let target = Object.keys(need).reduce((a,b)=>need[a]>need[b]?a:b);
    if (need[target]<=0) target = members[Math.floor(Math.random()*3)];
    count[target]++;
    weekAlloc[target]++;
    weekCodes[target].push(codes[i]);
  }

  const today = new Date();
  const dateString = today.toISOString().split('T')[0];

  logData.push({
    date: dateString,
    n,
    alloc: weekAlloc,
    codes: weekCodes
  });

  renderLog();
  updateStatus();
  saveData();

  document.getElementById('codes').value = '';
}
</script>
