<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>每週案件抽分系統（3:2:2）</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin: 5px; padding: 8px 12px; }
    .card { border: 1px solid #ccc; padding: 12px; margin-top: 12px; }
  </style>
</head>
<body>

<h2>每週案件抽分系統（3:2:2）</h2>

<div>
  <input id="cases" type="number" placeholder="本週案件數" />
  <br/><br/>
  <input id="codes" type="text"
    placeholder="輸入 8 碼暗號，用逗點分隔（例：12345678,87654321）"
    style="width:100%" />
  <br/><br/>
  <button onclick="allocate()">抽案件</button>
  <button onclick="resetAll()">全部重置</button>
</div>

<div class="card" id="status"></div>
<div class="card" id="log"></div>

<script>
let total = 0;
let count = { A: 0, B: 0, C: 0 };
let week = 0;
const ratio = { A: 3, B: 2, C: 2 };
const ratioSum = 7;
let logData = [];

// 讀取 localStorage
function loadData() {
  const saved = localStorage.getItem('caseAllocatorData');
  if (saved) {
    try {
      const data = JSON.parse(saved);
      total = data.total || 0;
      count = data.count || { A:0, B:0, C:0 };
      week = data.week || 0;
      logData = Array.isArray(data.log) ? data.log : [];
      renderLog();
      updateStatus();
    } catch(e) {
      console.log('localStorage 解析錯誤，忽略資料');
    }
  }
}

// 存檔 localStorage
function saveData() {
  localStorage.setItem('caseAllocatorData', JSON.stringify({
    total,
    count,
    week,
    log: logData
  }));
}

function allocate() {
  const n = parseInt(document.getElementById('cases').value);
  const codeInput = document.getElementById('codes').value.trim();
  let codes = codeInput ? codeInput.split(',').map(c => c.trim()) : [];

  if (!n) return;
  if (codes.length && codes.length !== n) {
    alert('暗號數量需與案件數一致');
    return;
  }

  let weekAlloc = { A: 0, B: 0, C: 0 };
  let weekCodes = { A: [], B: [], C: [] };

  for (let i = 0; i < n; i++) {
    total++;

    let should = {
      A: total * ratio.A / ratioSum,
      B: total * ratio.B / ratioSum,
      C: total * ratio.C / ratioSum
    };

    let need = {
      A: should.A - count.A,
      B: should.B - count.B,
      C: should.C - count.C
    };

    let target = Object.keys(need).reduce((a,b)=>need[a]>need[b]?a:b);

    if (need[target] <= 0) {
      const r = ['A','B','C'];
      target = r[Math.floor(Math.random()*3)];
    }

    count[target]++;
    weekAlloc[target]++;
    if (codes.length) weekCodes[target].push(codes[i]);
  }

  week++;
  const weekEntry = {
    week,
    n,
    alloc: weekAlloc,
    codes: weekCodes
  };
  logData.push(weekEntry);

  renderLog();
  updateStatus();
  saveData(); // 存檔
}

function renderLog() {
  const logDiv = document.getElementById('log');
  logDiv.innerHTML = '';
  logData.forEach(w => {
    logDiv.innerHTML +=
      `<div>
        第 ${w.week} 週（${w.n} 件）<br/>
        A：${w.alloc.A} 件 ${w.codes.A.length ? '→ ['+w.codes.A.join(', ')+']' : ''}<br/>
        B：${w.alloc.B} 件 ${w.codes.B.length ? '→ ['+w.codes.B.join(', ')+']' : ''}<br/>
        C：${w.alloc.C} 件 ${w.codes.C.length ? '→ ['+w.codes.C.join(', ')+']' : ''}
      </div><hr/>`;
  });
}

function updateStatus() {
  document.getElementById('status').innerHTML =
    `累積案件 ${total} 件<br>A:${count.A} B:${count.B} C:${count.C}`;
}

function resetAll() {
  if (!confirm('確定要全部重置嗎？')) return;
  total = 0;
  count = { A:0, B:0, C:0 };
  week = 0;
  logData = [];
  localStorage.removeItem('caseAllocatorData');
  renderLog();
  updateStatus();
}

loadData(); // 初始化時讀取
</script>

</body>
</html>
