<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>案件抽分 + 暗號輪流分配系統</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin: 5px; padding: 8px 12px; }
    .container { display: flex; gap: 20px; }
    .card { border: 1px solid #ccc; padding: 12px; margin-top: 12px; width: 100%; overflow-x:auto; }
    .section { flex: 1; padding: 10px; border-radius: 5px; }
    .left { background-color: #f0f8ff; } /* AliceBlue */
    .right { background-color: #fff8dc; } /* Cornsilk */
    h3 { margin-top:0; }
  </style>
</head>
<body>

<h2>案件抽分系統 & 暗號輪流分配系統</h2>

<div class="container">
  <!-- 左邊：案件抽分系統 -->
  <div class="section left">
    <h3>案件抽分系統（3:2:2）</h3>

    <input id="codes" type="text"
      placeholder="輸入 8 碼暗號，用逗號分隔"
      style="width:100%" />
    <br/><br/>

    <button onclick="allocate()">抽</button>
    <button onclick="resetAll()">全部重置</button>

    <div class="card" id="status"></div>
    <div class="card" id="log"></div>
  </div>

  <!-- 右邊：暗號輪流分配系統 -->
  <div class="section right">
    <h3>暗號輪流分配系統</h3>
    <input id="rotCodes" type="text"
      placeholder="輸入暗號，用逗號分隔"
      style="width:100%" />
    <br/><br/>
    <button onclick="allocateRot()">分配暗號</button>
    <button onclick="resetRot()">重置輪流分配</button>

    <div class="card" id="rotLog"></div>
  </div>
</div>

<script>
// ---------------------- 左邊案件抽分 ----------------------
let total = 0;
let count = { Mark:0, Galen:0, Kevin:0 };
const ratio = { Mark:3, Galen:2, Kevin:2 };
const ratioSum = 7;
let logData = [];

function loadData() {
  // 左邊
  const saved = localStorage.getItem('caseAllocatorData');
  if (saved) {
    try {
      const data = JSON.parse(saved);
      total = data.total || 0;
      count = data.count || { Mark:0, Galen:0, Kevin:0 };
      logData = Array.isArray(data.log) ? data.log : [];
      renderLog();
      updateStatus();
    } catch(e) { console.log('localStorage 解析錯誤'); }
  }

  // 右邊
  const savedRot = localStorage.getItem('rotatorData');
  if (savedRot) {
    try {
      const data = JSON.parse(savedRot);
      rotLogData = Array.isArray(data.log) ? data.log : [];
      rotIndex = typeof data.nextIndex === 'number' ? data.nextIndex : 0;
      renderRotLog();
    } catch(e){ console.log('輪流分配 localStorage 錯誤'); }
  }
}

function saveData() {
  localStorage.setItem('caseAllocatorData', JSON.stringify({
    total,
    count,
    log: logData
  }));
}

function allocate() {
  const codeInput = document.getElementById('codes').value.trim();
  
  // 防呆：必須輸入至少一個暗號
  if (!codeInput) {
    alert('請輸入至少一個暗號再抽分');
    return;
  }

  let codes = codeInput.split(',').map(c=>c.trim());
  const n = codes.length; // 件數依輸入暗號數量

  let weekAlloc = { Mark:0, Galen:0, Kevin:0 };
  let weekCodes = { Mark:[], Galen:[], Kevin:[] };
  const members = ['Mark','Galen','Kevin'];

  for (let i=0;i<n;i++){
    total++;
    let should = {
      Mark: total*ratio.Mark/ratioSum,
      Galen: total*ratio.Galen/ratioSum,
      Kevin: total*ratio.Kevin/ratioSum
    };
    let need = {
      Mark: should.Mark - count.Mark,
      Galen: should.Galen - count.Galen,
      Kevin: should.Kevin - count.Kevin
    };
    let target = Object.keys(need).reduce((a,b)=>need[a]>need[b]?a:b);
    if (need[target]<=0) target = members[Math.floor(Math.random()*3)];
    count[target]++;
    weekAlloc[target]++;
    weekCodes[target].push(codes[i]);
  }

  const today = new Date();
  const dateString = today.toISOString().split('T')[0];

  logData.push({
    date: dateString,
    n,
    alloc: weekAlloc,
    codes: weekCodes
  });

  renderLog();
  updateStatus();
  saveData();

  document.getElementById('codes').value = ''; // 抽完自動清空
}

function renderLog() {
  const logDiv = document.getElementById('log');
  logDiv.innerHTML = '';
  logData.forEach(w=>{
    logDiv.innerHTML +=
      `<div>
        分配日期：${w.date} （${w.n} 件）<br/>
        Mark：${w.alloc.Mark} 件 ${w.codes.Mark.length ? '→ ['+w.codes.Mark.join(', ')+']' : ''}<br/>
        Galen：${w.alloc.Galen} 件 ${w.codes.Galen.length ? '→ ['+w.codes.Galen.join(', ')+']' : ''}<br/>
        Kevin：${w.alloc.Kevin} 件 ${w.codes.Kevin.length ? '→ ['+w.codes.Kevin.join(', ')+']' : ''}
      </div><hr/>`;
  });
}

function updateStatus() {
  document.getElementById('status').innerHTML =
    `累積案件 ${total} 件<br>Mark:${count.Mark} Galen:${count.Galen} Kevin:${count.Kevin}`;
}

function resetAll() {
  if (!confirm('確定要全部重置嗎？')) return;
  total=0; count={Mark:0,Galen:0,Kevin:0}; logData=[];
  localStorage.removeItem('caseAllocatorData');
  renderLog(); updateStatus();
}

// ---------------------- 右邊輪流分配 ----------------------
let rotLogData = [];
let rotIndex = 0; // 下一個分配的成員索引
const rotMembers = ['Mark','Galen','Kevin'];

function allocateRot() {
  const codeInput = document.getElementById('rotCodes').value.trim();

  // 防呆：必須輸入至少一個暗號
  if (!codeInput) {
    alert('請輸入至少一個暗號再分配');
    return;
  }

  let codes = codeInput.split(',').map(c=>c.trim());
  const today = new Date();
  const dateString = today.toISOString().split('T')[0];

  codes.forEach(code=>{
    const member = rotMembers[rotIndex % rotMembers.length];
    rotLogData.push({ date: dateString, member, code });
    rotIndex++;
  });

  renderRotLog();
  saveRotData();
  document.getElementById('rotCodes').value = '';
}

function renderRotLog() {
  const logDiv = document.getElementById('rotLog');
  logDiv.innerHTML = '';
  rotLogData.forEach(entry=>{
    logDiv.innerHTML += `<div>${entry.date} → ${entry.member}: ${entry.code}</div>`;
  });
}

function saveRotData() {
  localStorage.setItem('rotatorData', JSON.stringify({
    log: rotLogData,
    nextIndex: rotIndex
  }));
}

function resetRot() {
  if (!confirm('確定要重置輪流分配嗎？')) return;
  rotLogData=[]; rotIndex=0;
  localStorage.removeItem('rotatorData');
  renderRotLog();
}

// 初始化
loadData();
</script>

</body>
</html>
